# ========================================
# Builder stage com ferramentas
# ========================================
FROM cgr.dev/chainguard/python:latest-dev as builder

# Instala Poetry e garante que está no PATH
RUN pip install --user poetry==2.1.3

# Adiciona o diretório user do pip ao PATH
ENV PATH="/home/nonroot/.local/bin:$PATH"

ENV POETRY_NO_INTERACTION=1 \
    POETRY_VIRTUALENVS_IN_PROJECT=1 \
    POETRY_VIRTUALENVS_CREATE=1 \
    POETRY_CACHE_DIR=/tmp/poetry_cache

WORKDIR /app

COPY pyproject.toml poetry.lock ./

# Instala dependências
RUN --mount=type=cache,target=$POETRY_CACHE_DIR poetry install --without dev --no-root

ENV PATH="/app/.venv/bin:$PATH"

# Bootstrap OpenTelemetry
RUN opentelemetry-bootstrap -a install

# ========================================
# Runtime mínimo com Chainguard
# ========================================
FROM cgr.dev/chainguard/python:latest

ENV VIRTUAL_ENV=/app/.venv \
    PATH="/app/.venv/bin:$PATH" \
    PYTHONUNBUFFERED=1

WORKDIR /app

# Copia virtualenv do builder
COPY --from=builder ${VIRTUAL_ENV} ${VIRTUAL_ENV}

# Copia código da aplicação
COPY app ./app
COPY migrations ./migrations
COPY alembic.ini ./
COPY pyproject.toml poetry.lock ./

EXPOSE 80

CMD ["sh", "-c", "alembic upgrade head && opentelemetry-instrument uvicorn --proxy-headers --host 0.0.0.0 --port 80 app.main:app"]